#!/bin/bash
# Pre-push hook to run fast quality checks
# Prevents pushing code that will fail CI quality checks

set -e  # Exit on first error

echo "ðŸ” Running pre-push quality checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
FAILED=0

# Backend checks
echo "ðŸ“¦ Backend Quality Checks"
echo "========================="

cd backend

# Linting
echo -n "  Linting... "
if ./venv/bin/ruff check . > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${RED}âœ—${NC}"
    echo -e "${RED}  Run 'cd backend && make lint' to see errors${NC}"
    FAILED=1
fi

# Type checking
echo -n "  Type checking... "
if ./venv/bin/mypy *.py > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${YELLOW}âš ${NC} (type errors exist but not blocking)"
fi

# Security check
echo -n "  Security scan... "
if ./venv/bin/bandit -r . -c pyproject.toml > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${RED}âœ—${NC}"
    echo -e "${RED}  Run 'cd backend && make security' to see issues${NC}"
    FAILED=1
fi

cd ..

echo ""

# Frontend checks
echo "ðŸŽ¨ Frontend Quality Checks"
echo "=========================="

cd frontend

# Linting
echo -n "  Linting... "
if npm run lint > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${RED}âœ—${NC}"
    echo -e "${RED}  Run 'cd frontend && npm run lint' to see errors${NC}"
    FAILED=1
fi

# Type checking
echo -n "  Type checking... "
if npm run type-check > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${RED}âœ—${NC}"
    echo -e "${RED}  Run 'cd frontend && npm run type-check' to see errors${NC}"
    FAILED=1
fi

# Format checking
echo -n "  Format checking... "
if npm run format:check > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC}"
else
    echo -e "${RED}âœ—${NC}"
    echo -e "${RED}  Run 'cd frontend && npm run format' to fix formatting${NC}"
    FAILED=1
fi

cd ..

echo ""

# Summary
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}âœ“ All quality checks passed!${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}âœ— Quality checks failed. Please fix the issues above before pushing.${NC}"
    echo ""
    echo "To skip this hook (not recommended), use: git push --no-verify"
    echo ""
    exit 1
fi
