name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual deployment

jobs:
  # Deploy to production (CI must pass first via branch protection or ci.yml trigger)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

      - name: Add DigitalOcean host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to DigitalOcean
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USER: ${{ secrets.DO_USER }}
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_MONGADO_SERVICE_ACCOUNT_TOKEN }}
          ADMIN_PASSKEY: ${{ secrets.ADMIN_PASSKEY }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        run: |
          # Pass secrets to remote server via SSH command arguments
          ssh $DO_USER@$DO_HOST "bash -s" \
            "$CORS_ORIGINS" \
            "$OP_SERVICE_ACCOUNT_TOKEN" \
            "$ADMIN_PASSKEY" \
            "$NEXT_PUBLIC_API_URL" \
            "$NEO4J_PASSWORD" << 'EOF'
            set -e

            # Receive arguments
            CORS_ORIGINS="$1"
            OP_SERVICE_ACCOUNT_TOKEN="$2"
            ADMIN_PASSKEY="$3"
            NEXT_PUBLIC_API_URL="$4"
            NEO4J_PASSWORD="$5"

            echo "ðŸ“¦ Deploying Mongado to production..."

            # Navigate to project directory
            cd /opt/mongado || { echo "Project directory not found"; exit 1; }

            # Pull latest changes
            echo "ðŸ”„ Pulling latest code from main branch..."
            git fetch origin
            git reset --hard origin/main

            # Create/update environment file
            echo "ðŸ” Setting up environment variables..."
            cat > backend/.env << ENVEOF
DEBUG=false
CORS_ORIGINS=$CORS_ORIGINS
OP_MONGADO_SERVICE_ACCOUNT_TOKEN=$OP_SERVICE_ACCOUNT_TOKEN
ADMIN_TOKEN=$ADMIN_PASSKEY
ENVEOF

            # Export environment variables for docker-compose
            export NEXT_PUBLIC_API_URL="$NEXT_PUBLIC_API_URL"
            export OP_MONGADO_SERVICE_ACCOUNT_TOKEN="$OP_SERVICE_ACCOUNT_TOKEN"
            export NEO4J_PASSWORD="$NEO4J_PASSWORD"
            export NEO4J_AUTH="neo4j/$NEO4J_PASSWORD"

            # Build and restart containers
            echo "ðŸ³ Building and restarting Docker containers..."
            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d

            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 10

            # Pull Ollama model if not already present
            echo "ðŸ¤– Setting up Ollama model..."
            docker exec mongado-ollama-prod ollama pull llama3.2:latest || echo "âš ï¸  Failed to pull Ollama model, will retry on next deployment"

            # Health check
            echo "ðŸ¥ Running health checks..."
            if curl -f http://localhost:8000/ > /dev/null 2>&1; then
              echo "âœ… Backend is healthy"
            else
              echo "âŒ Backend health check failed"
              docker compose -f docker-compose.prod.yml logs backend
              exit 1
            fi

            if curl -f http://localhost:3000/ > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy"
            else
              echo "âŒ Frontend health check failed"
              docker compose -f docker-compose.prod.yml logs frontend
              exit 1
            fi

            # Clean up old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            echo "âœ… Deployment complete!"
          EOF

      - name: Deployment notification
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying production deployment..."
          sleep 5

          # Check backend API
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.mongado.com/ || echo "000")
          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "âœ… Backend API responding (Status: $BACKEND_STATUS)"
          else
            echo "âš ï¸  Backend API status: $BACKEND_STATUS"
          fi

          # Check frontend
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://mongado.com/ || echo "000")
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "âœ… Frontend responding (Status: $FRONTEND_STATUS)"
          else
            echo "âš ï¸  Frontend status: $FRONTEND_STATUS"
          fi

  # Rollback if deployment fails
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

      - name: Add DigitalOcean host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: Rollback deployment
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USER: ${{ secrets.DO_USER }}
        run: |
          ssh $DO_USER@$DO_HOST << 'EOF'
            set -e

            echo "âš ï¸  Deployment failed, attempting rollback..."

            cd /opt/mongado

            # Rollback to previous git commit
            git reset --hard HEAD~1

            # Restart containers with previous version
            docker compose -f docker-compose.prod.yml up -d

            echo "âœ… Rollback complete"
          EOF
